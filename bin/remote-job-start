#!/bin/bash

# Launch a new job on a remote compute node.

while getopts "ct" F; do
  case $F in
    "c" )
      CLUSTER=1
      ;;
    "t" )
      TAIL_STDOUT=1
      ;;
  esac
done

# Strip off optional arguments
shift $((OPTIND-1))

if [[ "$#" -lt 1 ]]; then
  echo "usage: $0 [options] HOST [FILE-TO-COPY ...] < CMDS" 1>&2
  echo "options:" 1>&2
  echo "  -c   HOST specifies cluster file, not single hostname." 1>&2
  echo "  -t   Tail stdout of launched job." 1>&2
  exit -1
fi

if [[ "$CLUSTER" == 1 ]]; then
  HOST=$(cat $1 | shuf | head -n 1)
else
  HOST=$1
fi
shift

# Make new job directory, write commands from our stdin.
RESULT_DIR=research/results
JOB=$(ssh $HOST "cd $RESULT_DIR \
  && F=\$(local-job-mkdir) \
  && echo \$F \
  && cat > \$F/.cmds") || exit -1
EXP_DIR=$RESULT_DIR/$JOB
echo $JOB
# Copy local files to remote dir.
if [[ "$#" -gt 0 ]]; then
  scp "$@" $HOST:$EXP_DIR || exit -1
fi
# Launch job.
CMD="local-job-start $EXP_DIR bash .cmds 1>$EXP_DIR/log 2>$EXP_DIR/err &"
if [[ "$TAIL_STDOUT" == 1 ]]; then
  CMD="($CMD); tail -f $EXP_DIR/log"
fi
ssh -q $HOST bash -l <<<$CMD

